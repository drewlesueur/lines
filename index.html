<!doctype html>
<html>
<head>
<style>
textarea {
  width: 500px;
  height: 100px;
}
</style>
<script>
var pc = 0;
var scope = {};
var types = {};
var lines;
function trim(str) {
      match = str.match(/^[\s]*([^\s]+)[\s]*$/);
      if (match) {
          return match[1];
      }
}

function replacer(match, inner, offset, s) {
    inner = inner.substring(1).substring(0,inner.length-2)
    return  "." + lookup(inner);
}

function get_var_name(str) {
  console.log("getting " + str)
  str = str.replace(/(\[[^\]]+\])/g, replacer);
  return str;
}

var funcs = {
  equal: function(a, b) {
     return a == b;
  }
}
var returns = [];
var last_if = false;


function tokenize(line) {
    line = line.split("");
    i = 0;
    var state = "out";
    var cur_token = []
    var tokens = [];
    var last_chr = "";
    while (i < line.length) {
        chr = line[i];
        if (chr == " " && state == "out") {
            tokens.push(cur_token.join(""))
            cur_token = []
        } else if (chr == '"' && state == "out") {
            state = "in";
            cur_token.push("'")
        } else if (chr == '"' && state == "in" && last_chr != "\\") {
            state = "out";
        } else {
             cur_token.push(chr)
        }
        
        last_chr = chr;
        i++
    }
    tokens.push(cur_token.join(""))
    //console.log(tokens)
    return tokens
}

function exec(tokens, line) {
  console.log(tokens)
  console.log(line)
  if (tokens.length == 1) {
      return lookup(tokens[0])
  }
  
  if (tokens[1] == "=") {
    tokens_after_equals = tokens.slice(2)
    line_after_equals = line.substr(line.indexOf(" =") + 2);
    exec_after_equal = exec(tokens_after_equals, line_after_equals);
    assign(tokens[0], exec_after_equal)
  }
 
 
  
}

function lookup(v) {
  
  if (v.match(/^[\d]/)) {
      return v;
  }
  if (v.substr(0,1) == "'")
  return v.substring(1);
  
  v = get_var_name(v);
  
  if (v in scope) {
      return scope[v];
  } else {
    return v
  }
  
}

function assign(ee,or){
  ee = get_var_name(ee);
  for (var i in scope) {
      if (i.match(new RegExp("^" + ee + "\\.*"))) {
          delete scope[i];
      }
  }
  scope[ee] = or
  console.log(ee + "=" + or )
 
  if (typeof or == "string" && or.length > 1)
  for (var i = 0; i < or.length; i++) {
          assign(ee + "." + i, or.charAt(i));
  }
}

function parse(txt) {
  lines = txt.split("\n");
  var line;
  var iters = 0;
  var next_len;
  while (pc < lines.length && iters < 25) {
      iters++
      line = lines[pc]
      match = line.match(/^[\s]*/)
      space_len = match[0]; 
      tokens = tokenize(line)
      exec(tokens,line);
      
      pc = pc + 1
      next_pc = pc
      while (next_pc < lines.length) {
          next_line = lines[next_pc];
          match = next_line.match(/^[\s]*/)
          next_space_len = match[0]
          
          if (next_space_len > space_len) {
              //skip
          } else if (next_space_len < space_len) {
             //return
          } else if (next_space_len == space_len) {
              pc = next_pc;
              break;
          }
          next_pc++
      }
      
  }
  pc = 0;
  
}
</script>
</head>
<body>
<textarea id="t"></textarea>
<br>
<input type="button" onclick="parse(document.getElementById('t').value)" value="run">
</body>
</html>
